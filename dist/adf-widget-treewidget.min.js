!function(e,n){"use strict";angular.module("adf.widget.treewidget",["adf.provider"]).config(["dashboardProvider",function(e){e.widget("treewidget",{title:"Tree Builder",description:"build a D3 Tree Visualization",templateUrl:"{widgetsPath}/treewidget/src/view.html",reload:!0,frameless:!1,styleClass:"NOA",controller:"TreeWidgetCtrl",edit:{templateUrl:"{widgetsPath}/treewidget/src/edit.html",reload:!0,controller:"TreeWidgetConfigCtrl"}})}]).controller("TreeWidgetConfigCtrl",["$scope","config","$window","$document","$compile","$parse","$http","dashboard","$sce",function(e,n,t,i,o,r,a,d,c){n.url||(n.url="/llp_core/data.json"),e.config=n,e.configured=function(){return""!==e.config.content},e.notConfigured=function(){return""===e.config.content},e.loadData=function(e){a.get(e.url).then(function(n){e.data=n.data})},n.url&&(this.url=c.trustAsResourceUrl(n.url))}]).controller("TreeWidgetCtrl",["$scope","config","$window","$document","$compile","$parse","$http","dashboard","$sce",function(e,n,t,i,o,r,a,d,c){n.url||(n.url=""),e.config=n,e.loadTemplate=function(e){a.get(e.url).then(function(n){e.data=n.data})},n.url&&(this.url=c.trustAsResourceUrl(n.url)),n.data&&(this.data=n.data)}]).factory("config",function(){return function(){var e={url:"/llp_core/data.json",diameter:"500"};return e}}),angular.module("adf.widget.treewidget").run(["$templateCache",function(e){e.put("{widgetsPath}/treewidget/src/edit.html",'<form role=form><div class=form-group><label for=sample>Sample</label> <input type=url class=form-control id=sample ng-model=config.url placeholder="Enter sample"> <input type=number class=form-control id=num ng-model=config.diameter></div></form>'),e.put("{widgetsPath}/treewidget/src/view.html",'<div class=container-fluid><div><h1 class=text-center>Architecture Tree</h1><div ng-controller=filterCtrl><ng-include src="\'filter.html\'"></ng-include></div><div ng-controller=chartCtrl><tree-chart-widget data=tree diameter="{{config.diameter || \'500\'}}"></tree-chart-widget><d3pendingtree patent=7654321 pattern tree=tree></d3pendingtree></div><div ng-controller=panelCtrl><div id=panel><div ng-if=detail><ng-include src="\'panel-detail.html\'"></ng-include></div><div ng-if=edit><ng-include src="\'panel-edit.html\'"></ng-include></div></div></div><div ng-controller=undoCtrl><div ng-if=hasHistory() class="alert alert-success json-update-label bg-success">Updated JSON <a ng-click=undo()>(undo)</a></div></div><div ng-controller=jsonDataCtrl><textarea id=json-data class="form-control card card-dark well" style=margin-top:50%; ng-model=data ng-blur=updateData()></textarea></div></div></div><script src=/treewidget/src/d3.architectureTree.js></script><script src=/treewidget/src/app.js></script><script src=/treewidget/src/chart.js></script><script src=/treewidget/src/filter.js></script><script src=/treewidget/src/json-data.js></script><script src=/treewidget/src/panel.js></script><script src=/treewidget/src/undo.js></script><script src=/treewidget/src/tree-chart.js></script><script src=/treewidget/src/init-focus.js></script><script src=/treewidget/src/data.js></script><script src=/treewidget/src/bus.js></script><script src=/treewidget/src/data.json></script><script type=text/ng-template id=filter.html><div class="filters panel panel-default"> <div class="panel-heading">Search</div> <div class="panel-body"> <form id="filter_form"> <input name="name" type="text" class="form-control" placeholder="Filter by name" ng-model="$parent.nameFilter" /> <div id="technos"> <h5>Technos</h5> <a ng-repeat="techno in technos" class="btn btn-default btn-xs" ng-click="toggleTechnoFilter(techno)" ng-class="{\'btn-primary\': isTechnoInFilter(techno) }">{{ techno }}</a> </div> <div id="host"> <h5>Host</h5> <a ng-repeat="host in hosts" class="btn btn-default btn-xs" ng-click="toggleHostFilter(host)" ng-class="{\'btn-primary\': isHostInFilter(host) }">{{ host }}</a> </div> </form> </div> </div></script><script type=text/ng-template id=panel-detail.html><div class="details panel panel-info"> <div class="panel-heading">{{ node.name }}</div> <div class="panel-body"> <div class="url" ng-if="node.url"> <a href="{{ node.url }}">{{ node.url }}</a> </div> <div class="comments panel panel-default" ng-if="node.comments"> <div class="panel-heading">{{ node.comments }}</div> </div> <div class="properties" ng-if="node.details.Dependencies"> <h5>Depends on</h5> <ul> <li ng-repeat="dependency in node.details.Dependencies"> {{ dependency }} </li> </ul> </div> <div class="properties" ng-if="node.details.Dependents"> <h5>Dependendents</h5> <ul> <li ng-repeat="dependent in node.details.Dependents"> {{ dependent }} </li> </ul> </div> <div class="properties" ng-if="node.details.Technos"> <h5>Technos</h5> <ul> <li ng-repeat="techno in node.details.Technos"> {{ techno }} </li> </ul> </div> <div class="properties" ng-if="node.details.Host"> <h5>Hosts</h5> <ul> <li ng-repeat="(hostName, servers) in node.host"> {{ hostName }} <ul ng-if="servers"> <li ng-repeat="server in servers">{{ server }}</li> </ul> <span ng-if="detail.via">({{ detail.via }})</span> </li> </ul> </div> </div> </div></script><script type=text/ng-template id=panel-edit.html><form name="editForm" ng-submit="editNode(editForm, $event)"> <div class="details panel panel-info"> <div class="panel-heading"> <input type="text" ng-model="node.name" class="form-control" /> </div> <div class="panel-body"> <div class="url"> <h5>Url</h5> <input type="text" ng-model="node.url" class="form-control" init-focus /> </div> <div class="comments"> <h5>Comments</h5> <textarea ng-model="node.comments" class="form-control" init-focus></textarea> </div> <div class="properties edit"> <h5>Depends on <span class="glyphicon glyphicon-plus" ng-click="addDependency()"></span></h5> <ul> <li ng-repeat="dependencies in node.dependsOn track by $index"> <input type="text" ng-model="node.dependsOn[$index]" init-focus /> <span class="remove glyphicon glyphicon-remove" ng-click="deleteDependency($index)"></span> </li> </ul> <h5>Technos <span class="glyphicon glyphicon-plus" ng-click="addTechno()"></span></h5> <ul> <li ng-repeat="techno in node.technos track by $index"> <input type="text" ng-model="node.technos[$index]" init-focus /> <span class="remove glyphicon glyphicon-remove" ng-click="deleteTechno($index)"></span> </li> </ul> <h5>Hosts <span class="glyphicon glyphicon-plus" ng-click="addHostCategory()"></span></h5> <ul> <li ng-repeat="(key, host) in node.host track by $index"> <input type="text" ng-model="hostKeys[key]" init-focus /><span class="glyphicon glyphicon-plus" ng-click="addHost(key)"></span> <span class="remove glyphicon glyphicon-remove" ng-click="deleteHostCategory(key)"></span> <ul> <li ng-repeat="test in node.host[key] track by $index"> <span class="remove glyphicon glyphicon-remove" ng-click="deleteHost(key, $index)"></span> <input type="text" ng-model="node.host[key][$index]" init-focus /> </li> </ul> </li> </ul> </div> </div> <div class="panel-footer"> <button type="button" ng-click="addNode()" class="btn btn-default"><span class="glyphicon glyphicon-plus"></span> Add</button> <button type="button" ng-click="moveNode()" class="btn btn-default"><span class="glyphicon glyphicon-share-alt"></span> Move</button> <button type="button" ng-click="deleteNode()" class="btn btn-warning"><span class="glyphicon glyphicon-trash"></span> Delete</button> </div> <div class="panel-footer"> <button type="submit" class="btn btn-primary"><span class="glyphicon glyphicon-ok"></span> Save</button> <button type="button" ng-click="leaveEdit()" class="btn btn-default"><span class="glyphicon glyphicon-remove"></span> Cancel</button> </div> </div> </form></script>')}]),angular.module("adf.widget.treewidget").controller("undoCtrl",["$scope","bus","data",function(e,n,t){var i=[];n.on("updateData",function(e){i.push(angular.copy(e))}),e.hasHistory=function(){return i.length>1},e.undo=function(){i.pop(),t.setJsonData(i.pop())}}]),angular.module("adf.widget.treewidget").directive("treeChartWidget",["bus","d3Service",function(e,n){return{restrict:"E",replace:!0,template:'<div id="graph"></div>',scope:{data:"="},link:function(t,i){n.d3().then(function(n){var o=n.chart.architectureTree();t.$watch("data",function(e){"undefined"!=typeof e&&(o.diameter(960).data(t.data),n.select(i[0]).call(o))}),e.on("nameFilterChange",function(e){o.nameFilter(e)}),e.on("technosFilterChange",function(e){o.technosFilter(e)}),e.on("hostsFilterChange",function(e){o.hostsFilter(e)}),e.on("select",function(e){o.select(e)}),e.on("unselect",function(){o.unselect()})})}}}]),angular.module("adf.widget.treewidget").controller("panelCtrl",["$scope","$timeout","$window","data","bus",function(e,n,t,i,o){function r(e){var n=function(e){e.children&&e.children.forEach(function(t){t.parent=e,n(t)})},t=function(n){n.dependsOn&&n.dependsOn.forEach(function(t){var i=d(t,e);return i?(i.dependents||(i.dependents=[]),void i.dependents.push(n.name)):void console.log("Dependency",t,"not found for node",n)}),n.children&&n.children.map(t)},i=function(e){o(e),e.children&&e.children.map(i)},o=function(e){e.details={};var n=r(e,"dependsOn");n.length>0&&(e.details.Dependencies=n.map(a)),e.dependents&&(e.details.Dependents=e.dependents);var t=r(e,"technos");if(t.length>0&&(e.details.Technos=t.map(a)),e.host){e.details.Host=[];for(var i in e.host)e.details.Host.push(i)}return e},r=function(e,n,t){var i=[];return e[n]&&e[n].forEach(function(e){i.push({value:e,via:t})}),e.parent&&(i=i.concat(r(e.parent,n,e.parent.name))),i},a=function(e){return e.via?e.value+" ("+e.via+")":e.value};return n(e),t(e),i(e),e}var a=angular.element(document.querySelector("#panel"));document.querySelector("#graph");o.on("updateData",function(n){var t=angular.copy(n);e.data=r(t)});var d=function(e,n){if(n.name===e)return n;if(!n.children)return null;for(var t=n.children.length-1;t>=0;t--){var i=d(e,n.children[t]);if(i)return i}};a.on("hoverNode",function(n){e.node=d(n.detail,e.data),e.detail=!0,e.edit=!1,e.$digest()}).on("selectNode",function(n){e.enterEdit(n.detail),e.$digest()}).on("unSelectNode",function(n){e.edit&&(e.leaveEdit(),e.$digest())}),e.enterEdit=function(n){e.originalNode=d(n,e.data),e.node=angular.copy(e.originalNode),e.detail=!1,e.edit=!0,e.hostKeys={},angular.forEach(e.node.host,function(n,t){e.hostKeys[t]=t})},e.leaveEdit=function(){e.node=angular.copy(e.originalNode),e.detail=!0,e.edit=!1,o.emit("unselect")},e.editNode=function(n,t){t.preventDefault(),angular.forEach(e.hostKeys,function(n,t){n!==t&&(e.node.host[n]=angular.copy(e.node.host[t]),delete e.node.host[t])}),i.updateNode(e.originalNode.name,e.node),i.emitRefresh(),e.node=d(e.node.name,e.data),e.detail=!0,e.edit=!1},e.deleteNode=function(){t.confirm("Are you sure you want to delete that node?")&&(i.removeNode(e.originalNode.name),i.emitRefresh(),e.detail=!1,e.edit=!1)},e.moveNode=function(){var r=t.prompt("Please type the name of the parent node to move to");i.moveNode(e.originalNode.name,r),i.emitRefresh(),n(function(){o.emit("select",e.originalNode.name)})},e.addNode=function(){i.addNode(e.originalNode.name),i.emitRefresh(),n(function(){o.emit("select","New node")})},e.addDependency=function(){"undefined"==typeof e.node.dependsOn&&(e.node.dependsOn=[]),e.node.dependsOn.push("")},e.deleteDependency=function(n){e.node.dependsOn.splice(n,1)},e.addTechno=function(){"undefined"==typeof e.node.technos&&(e.node.technos=[]),e.node.technos.push("")},e.deleteTechno=function(n){e.node.technos.splice(n,1)},e.addHost=function(n){"undefined"==typeof e.node.host[n]&&(e.node.host[n]=[]),e.node.host[n].push("")},e.deleteHost=function(n,t){e.node.host[n].splice(t,1)},e.addHostCategory=function(){"undefined"==typeof e.node.host&&(e.node.host={}),e.node.host[""]=[],e.hostKeys[""]=""},e.deleteHostCategory=function(n){delete e.hostKeys[n],delete e.node.host[n]}}]),angular.module("adf.widget.treewidget").controller("jsonDataCtrl",["$scope","bus","data",function(e,t,i){var o;t.on("updateData",function(t){o=t,e.data=JSON.stringify(t,n,2)}),e.updateData=function(){var n=JSON.parse(e.data);angular.equals(n,o)||i.setJsonData(n)}}]),angular.module("adf.widget.treewidget").directive("initFocus",function(){var e;return function(n,t,i){e&&clearTimeout(e),e=setTimeout(function(){t[0].focus()},0)}}),angular.module("adf.widget.treewidget").controller("filterCtrl",["$scope","bus",function(e,n){function t(e){function n(e){e.technos&&e.technos.forEach(function(e){t[e]=!0}),e.children&&e.children.forEach(function(e){n(e)})}var t=[];return n(e),Object.keys(t).sort()}function i(e){function n(e){if(e.host)for(var i in e.host)t[i]=!0;e.children&&e.children.forEach(function(e){n(e)})}var t={};return n(e),Object.keys(t).sort()}n.on("updateData",function(n){e.technos=t(n),e.hosts=i(n)}),e.nameFilter="";var o=[],r=[];e.$watch("nameFilter",function(e){n.emit("nameFilterChange",e)}),e.toggleTechnoFilter=function(t){e.isTechnoInFilter(t)?o.splice(o.indexOf(t),1):o.push(t),n.emit("technosFilterChange",o)},e.isTechnoInFilter=function(e){return-1!==o.indexOf(e)},e.toggleHostFilter=function(t){e.isHostInFilter(t)?r.splice(r.indexOf(t),1):r.push(t),n.emit("hostsFilterChange",r)},e.isHostInFilter=function(e){return-1!==r.indexOf(e)}}]),angular.module("adf.widget.treewidget").service("data",["$http","$q","bus","config",function(e,n,t,i){var o,r=function(){return"undefined"!=typeof o?n.when(o):i.url?e.get(i.url).success(function(e){return c(e),e}):e.get("/llp_core/data.json").success(function(e){return c(e),e})},a=function(){t.emit("updateData",o)},d=function(){return o},c=function(e){o=e,a()},s=function(e,n){if(n=n||o,n.name===e)return n;if(!n.children)return null;for(var t=n.children.length-1;t>=0;t--){var i=s(e,n.children[t]);if(i)return i}},l=function(e,n){if(n=n||o,!n.children)return null;for(var t=n.children.length-1;t>=0;t--){if(n.children[t].name===e)return n;var i=l(e,n.children[t]);if(i)return i}},u=function(e,n){var t=s(e);p(t.name,n.name);for(var i in n)n.hasOwnProperty(i)&&"children"!==i&&"parent"!==i&&"details"!==i&&(t[i]=n[i])},p=function(e,n,t){t=t||o,h(e,n,t),"undefined"!=typeof t.children&&t.children.length&&t.children.forEach(function(t){p(e,n,t)})},f=function(e){p(e)},h=function(e,n,t){if("undefined"!=typeof t.dependsOn){var i=t.dependsOn.indexOf(e);-1!==i&&(n?t.dependsOn[i]=n:t.dependsOn.splice(i,1))}},g=function(e,n){n=n||{name:"New node"};var t=s(e);t.children||(t.children=[]),t.children.push(n)},m=function(e){var n=l(e);if(!n)return!1;for(var t=0,i=n.children.length;i>t;t++){var o=n.children[t];if(o.name===e)return y(o).map(f),n.children.splice(t,1)}},v=function(e,n){var t=m(e);return t&&0!==t.length?void g(n,t[0]):!1},y=function(e){var n=[e.name];return e.children&&e.children.forEach(function(e){n=n.concat(y(e))}),n};return{fetchJsonData:r,getJsonData:d,setJsonData:c,emitRefresh:a,getNodeByName:s,updateNode:u,addNode:g,removeNode:m,moveNode:v}}]),d3.chart=d3.chart||{},d3.chart.architectureTree=function(){function e(){"undefined"==typeof t&&(t=d3.layout.tree().size([360,o/2-120]).separation(function(e,n){return(e.parent==n.parent?1:2)/e.depth}),n=d3.select("#graph").append("svg").attr("width",o).attr("height",o).append("g").attr("transform","translate("+o/2+","+o/2+")"));var e=t.nodes(i),d=t.links(e);r=null,n.call(a,e,d)}var n,t,i,o,r,a=function(e,t,i){d(t),t.map(function(e){c(e)});var o=d3.svg.diagonal.radial().projection(function(e){return[e.y,e.x/180*Math.PI]}),a=n.selectAll(".link").data(i,function(e){return e.source.name+e.target.name+Math.random()});a.exit().remove(),a.enter().append("path").attr("class","link").attr("d",o);var s=e.selectAll(".node").data(t,function(e){return e.name+Math.random()});s.exit().remove();var l=s.enter().append("g").attr("class","node").attr("transform",function(e){return"rotate("+(e.x-90)+")translate("+e.y+")"}).on("mouseover",function(e){null===r&&(u(.1)(e),document.querySelector("#panel").dispatchEvent(new CustomEvent("hoverNode",{detail:e.name})))}).on("mouseout",function(e){null===r&&u(1)(e)}).on("click",function(e){g(e.name)});l.append("circle").attr("r",function(e){return 4.5*(e.size||1)}).style("stroke",function(e){return d3.scale.linear().domain([1,0]).range(["steelblue","red"])("undefined"!=typeof e.satisfaction?e.satisfaction:1)}).style("fill",function(e){return"undefined"==typeof e.satisfaction?"#fff":d3.scale.linear().domain([1,0]).range(["white","#f66"])("undefined"!=typeof e.satisfaction?e.satisfaction:1)}),l.append("text").attr("dy",".31em").attr("text-anchor",function(e){return e.x<180?"start":"end"}).attr("transform",function(e){return e.x<180?"translate(8)":"rotate(180)translate(-8)"}).text(function(e){return e.name})},d=function(e){var n=[];e.forEach(function(e){e.dependsOn&&e.dependsOn.forEach(function(t){n[t]||(n[t]=[]),n[t].push(e.name)})}),e.forEach(function(t,i){n[t.name]&&(e[i].dependents=n[t.name])})},c=function(e){e.index={relatedNodes:[],technos:[],hosts:[]};var n=s(e,"dependsOn");n.length>0&&(e.index.relatedNodes=e.index.relatedNodes.concat(n)),e.dependents&&(e.index.relatedNodes=e.index.relatedNodes.concat(e.dependents));var t=s(e,"technos");t.length>0&&(e.index.technos=t);var i=l(e);i.length>0&&(e.index.hosts=i)},s=function(e,n){var t=[];return e[n]&&e[n].forEach(function(e){t.push(e)}),e.parent&&(t=t.concat(s(e.parent,n))),t},l=function(e){var n=[];if(e.host)for(var t in e.host)n.push(t);return e.parent&&(n=n.concat(l(e.parent))),n},u=function(e){return function(t){n.selectAll(".node").filter(function(e){return e.name===t.name?!1:-1===t.index.relatedNodes.indexOf(e.name)}).transition().style("opacity",e)}},p={name:"",technos:[],hosts:[]},f=function(e){var n;if(!p.name&&!p.technos.length&&!p.hosts.length)return!0;if(p.name&&-1===e.name.toLowerCase().indexOf(p.name))return!1;var t=p.technos.length;if(t){if(0===e.index.technos.length)return!1;for(n=0;t>n;n++)if(-1===e.index.technos.indexOf(p.technos[n]))return!1}var i=p.hosts.length;if(i){if(0===e.index.hosts.length)return!1;for(n=0;i>n;n++)if(-1===e.index.hosts.indexOf(p.hosts[n]))return!1}return!0},h=function(){d3.selectAll(".node").classed("notFound",function(e){return!f(e)})},g=function(e){return r&&r.name==e?void m():(m(),void n.selectAll(".node").filter(function(n){return n.name===e?!0:void 0}).each(function(e){document.querySelector("#panel").dispatchEvent(new CustomEvent("selectNode",{detail:e.name})),d3.select(this).attr("id","node-active"),r=e,u(.1)(e)}))},m=function(){null!=r&&(u(1)(r),d3.select("#node-active").attr("id",null),r=null,document.querySelector("#panel").dispatchEvent(new CustomEvent("unSelectNode")))};return e.select=g,e.unselect=m,e.data=function(n){return arguments.length?(i=n,e):i},e.diameter=function(n){return arguments.length?(o=n,e):o},e.nameFilter=function(e){p.name=e,h()},e.technosFilter=function(e){p.technos=e,h()},e.hostsFilter=function(e){p.hosts=e,h()},e},angular.module("adf.widget.treewidget").controller("chartCtrl",["$scope","bus",function(e,n){n.on("updateData",function(n){e.data=angular.copy(n)})}]),angular.module("adf.widget.treewidget").service("bus",["$http","$q",function(e,n){var t={},i=function(e,n){t[e]||(t[e]=[]),t[e].push(n)},o=function(e,n){return t[e]?(t[e].forEach(function(e){e(n)}),!0):!1};return{on:i,emit:o}}]),angular.module("adf.widget.treewidget").run(["data",function(e){e.fetchJsonData().then(function(e){console.log("data loaded")},console.error)}])}(window);